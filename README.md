# 📸 PostingFotoTG — автоматический фотоотчёт из Bitrix24 в Telegram

### 🚀 Что делает проект
- Получает фото и видео из Bitrix24-диска (по `folder_id`)
- Скачивает и прикрепляет файлы к сделке (`UF_CRM_1740994275251`)
- Отправляет отчёт в Telegram в виде `sendMediaGroup`
- Генерирует подпись: 🧹 адрес + 👷 бригада + 🎣 вдохновляющий текст
- Добавляет комментарий в сделку (опционально)
- Антиспам: не повторяет отправку, если сделка уже обрабатывалась недавно

---

### 📂 Структура логики

| Компонент | Описание |
|----------|----------|
| `/webhook/register_folder` | JSON webhook для запуска по `deal_id + folder_id` |
| `/webhook/deal_update` | `x-www-form-urlencoded` от Bitrix24 (обрабатывается только один раз в 30 секунд) |
| `get_files_from_folder()` | Получает ID + ссылку `DOWNLOAD_URL` для скачивания из Bitrix24-диска |
| `attach_media_to_deal()` | Загружает файл в папку и прикрепляет к сделке через `disk.folder.uploadfile` и `crm.deal.update` |
| `send_report()` | Собирает отчёт: фото → подпись → Telegram → прикрепление в сделку |

---

### 📦 Пример запроса
```json
POST /webhook/register_folder
{
  "deal_id": 11720,
  "folder_id": 199058
}
```

---

### 🧠 GPT-подпись
Используется поле `UF_CRM_1669561599956` для адреса и `UF_CRM_1741590925181` для бригады. Если GPT отключён, используется fallback:
```text
Уборка завершена. Спасибо за чистоту 🧹
```

---

### ✅ Текущий стек:
- FastAPI / Uvicorn / Gunicorn
- Bitrix24 REST API
- Telegram Bot API
- OpenAI (1.75.0) + `pydantic`
- Render.com (деплой)

---

### 🛠 Разработка
Файл `.env` должен содержать:
```env
BITRIX_WEBHOOK=https://.../rest/1/...
TELEGRAM_TOKEN=123456:ABC...
TELEGRAM_CHAT_ID=-1001234567890
OPENAI_API_KEY=sk-...
```

---

### 🤖 Антиспам
Webhook `/webhook/deal_update` будет обработан только 1 раз в 30 секунд для одной и той же сделки.
Это предотвращает дублирование сообщений и загрузок.

---

### 📎 Ограничения Bitrix
- Имена файлов обрезаются до 50 символов
- Удаляются спецсимволы
- Размер base64-файла не должен превышать лимит Bitrix (~5MB на REST)

---

### 🧪 Проверка работоспособности
1. В Bitrix установите поле `UF_CRM_1743273170850` (ID папки с фото)
2. Измените стадию сделки — Webhook запустится
3. Фото отправятся в Telegram и прикрепятся к сделке

---

### ✅ Примеры логов
```bash
📤 Upload payload: icon.png (size: 213068 bytes)
✅ Ответ от Bitrix: {'result': True}
📎 Прикреплены файлы к сделке 11720: [199936, 199938]
```

---

> Авторы: @maslovmaksim92 + PostingFotoTG AI Bot 🤖