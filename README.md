# ๐ธ PostingFotoTG โ ะฐะฒัะพะผะฐัะธัะตัะบะธะน ัะพัะพะพัััั ะธะท Bitrix24 ะฒ Telegram

### ๐ ะงัะพ ะดะตะปะฐะตั ะฟัะพะตะบั
- ะะพะปััะฐะตั ัะพัะพ ะธ ะฒะธะดะตะพ ะธะท Bitrix24-ะดะธัะบะฐ (ะฟะพ `folder_id`)
- ะกะบะฐัะธะฒะฐะตั ะธ ะฟัะธะบัะตะฟะปัะตั ัะฐะนะปั ะบ ัะดะตะปะบะต (`UF_CRM_1740994275251`)
- ะัะฟัะฐะฒะปัะตั ะพัััั ะฒ Telegram ะฒ ะฒะธะดะต `sendMediaGroup`
- ะะตะฝะตัะธััะตั ะฟะพะดะฟะธัั: ๐งน ะฐะดัะตั + ๐ท ะฑัะธะณะฐะดะฐ + ๐ฃ ะฒะดะพัะฝะพะฒะปัััะธะน ัะตะบัั
- ะะพะฑะฐะฒะปัะตั ะบะพะผะผะตะฝัะฐัะธะน ะฒ ัะดะตะปะบั (ะพะฟัะธะพะฝะฐะปัะฝะพ)
- ะะฝัะธัะฟะฐะผ: ะฝะต ะฟะพะฒัะพััะตั ะพัะฟัะฐะฒะบั, ะตัะปะธ ัะดะตะปะบะฐ ัะถะต ะพะฑัะฐะฑะฐััะฒะฐะปะฐัั ะฝะตะดะฐะฒะฝะพ

---

### ๐ ะกัััะบัััะฐ ะปะพะณะธะบะธ

| ะะพะผะฟะพะฝะตะฝั | ะะฟะธัะฐะฝะธะต |
|----------|----------|
| `/webhook/register_folder` | JSON webhook ะดะปั ะทะฐะฟััะบะฐ ะฟะพ `deal_id + folder_id` |
| `/webhook/deal_update` | `x-www-form-urlencoded` ะพั Bitrix24 (ะพะฑัะฐะฑะฐััะฒะฐะตััั ัะพะปัะบะพ ะพะดะธะฝ ัะฐะท ะฒ 30 ัะตะบัะฝะด) |
| `get_files_from_folder()` | ะะพะปััะฐะตั ID + ัััะปะบั `DOWNLOAD_URL` ะดะปั ัะบะฐัะธะฒะฐะฝะธั ะธะท Bitrix24-ะดะธัะบะฐ |
| `attach_media_to_deal()` | ะะฐะณััะถะฐะตั ัะฐะนะป ะฒ ะฟะฐะฟะบั ะธ ะฟัะธะบัะตะฟะปัะตั ะบ ัะดะตะปะบะต ัะตัะตะท `disk.folder.uploadfile` ะธ `crm.deal.update` |
| `send_report()` | ะกะพะฑะธัะฐะตั ะพัััั: ัะพัะพ โ ะฟะพะดะฟะธัั โ Telegram โ ะฟัะธะบัะตะฟะปะตะฝะธะต ะฒ ัะดะตะปะบั |

---

### ๐ฆ ะัะธะผะตั ะทะฐะฟัะพัะฐ
```json
POST /webhook/register_folder
{
  "deal_id": 11720,
  "folder_id": 199058
}
```

---

### ๐ง GPT-ะฟะพะดะฟะธัั
ะัะฟะพะปัะทัะตััั ะฟะพะปะต `UF_CRM_1669561599956` ะดะปั ะฐะดัะตัะฐ ะธ `UF_CRM_1741590925181` ะดะปั ะฑัะธะณะฐะดั. ะัะปะธ GPT ะพัะบะปัััะฝ, ะธัะฟะพะปัะทัะตััั fallback:
```text
ะฃะฑะพัะบะฐ ะทะฐะฒะตััะตะฝะฐ. ะกะฟะฐัะธะฑะพ ะทะฐ ัะธััะพัั ๐งน
```

---

### โ ะขะตะบััะธะน ััะตะบ:
- FastAPI / Uvicorn / Gunicorn
- Bitrix24 REST API
- Telegram Bot API
- OpenAI (1.75.0) + `pydantic`
- Render.com (ะดะตะฟะปะพะน)

---

### ๐ ะะฐะทัะฐะฑะพัะบะฐ
ะคะฐะนะป `.env` ะดะพะปะถะตะฝ ัะพะดะตัะถะฐัั:
```env
BITRIX_WEBHOOK=https://.../rest/1/...
TELEGRAM_TOKEN=123456:ABC...
TELEGRAM_CHAT_ID=-1001234567890
OPENAI_API_KEY=sk-...
```

---

### ๐ค ะะฝัะธัะฟะฐะผ
Webhook `/webhook/deal_update` ะฑัะดะตั ะพะฑัะฐะฑะพัะฐะฝ ัะพะปัะบะพ 1 ัะฐะท ะฒ 30 ัะตะบัะฝะด ะดะปั ะพะดะฝะพะน ะธ ัะพะน ะถะต ัะดะตะปะบะธ.
ะญัะพ ะฟัะตะดะพัะฒัะฐัะฐะตั ะดัะฑะปะธัะพะฒะฐะฝะธะต ัะพะพะฑัะตะฝะธะน ะธ ะทะฐะณััะทะพะบ.

---

### ๐ ะะณัะฐะฝะธัะตะฝะธั Bitrix
- ะะผะตะฝะฐ ัะฐะนะปะพะฒ ะพะฑัะตะทะฐัััั ะดะพ 50 ัะธะผะฒะพะปะพะฒ
- ะฃะดะฐะปััััั ัะฟะตััะธะผะฒะพะปั
- ะะฐะทะผะตั base64-ัะฐะนะปะฐ ะฝะต ะดะพะปะถะตะฝ ะฟัะตะฒััะฐัั ะปะธะผะธั Bitrix (~5MB ะฝะฐ REST)

---

### ๐งช ะัะพะฒะตัะบะฐ ัะฐะฑะพัะพัะฟะพัะพะฑะฝะพััะธ
1. ะ Bitrix ัััะฐะฝะพะฒะธัะต ะฟะพะปะต `UF_CRM_1743273170850` (ID ะฟะฐะฟะบะธ ั ัะพัะพ)
2. ะะทะผะตะฝะธัะต ััะฐะดะธั ัะดะตะปะบะธ โ Webhook ะทะฐะฟัััะธััั
3. ะคะพัะพ ะพัะฟัะฐะฒัััั ะฒ Telegram ะธ ะฟัะธะบัะตะฟัััั ะบ ัะดะตะปะบะต

---

### โ ะัะธะผะตัั ะปะพะณะพะฒ
```bash
๐ค Upload payload: icon.png (size: 213068 bytes)
โ ะัะฒะตั ะพั Bitrix: {'result': True}
๐ ะัะธะบัะตะฟะปะตะฝั ัะฐะนะปั ะบ ัะดะตะปะบะต 11720: [199936, 199938]
```

---

> ะะฒัะพัั: @maslovmaksim92 + PostingFotoTG AI Bot ๐ค