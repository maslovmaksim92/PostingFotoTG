import os
from openai import AsyncOpenAI
from loguru import logger
from datetime import datetime
import pytz

client = AsyncOpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –±–∞–π—Ç–∞ –Ω–∞ –æ—Ç–∑—ã–≤ (1 –∏–∑ 10)
REVIEW_PROBABILITY = 10
REVIEW_LINKS = (
    "https://yandex.ru/profile/81116139636?lang=ru",
    "https://www.kaluga-poisk.ru/catalog/objects/vash-dom-kaluga",
    "https://2gis.ru/kaluga/search/%D0%92%D0%B0%D1%88%20%D0%B4%D0%BE%D0%BC/firm/70000001064313692/36.250311%2C54.580763",
    "https://zoon.ru/kaluga/building/obsluzhivanie_mnogokvartirnyh_domov_vash_dom_v_moskovskom_rajone/",
)

def get_current_moscow_date() -> str:
    moscow_tz = pytz.timezone("Europe/Moscow")
    now = datetime.now(moscow_tz)
    return now.strftime("%d %B %Y")

async def generate_message(address: str, responsible: str, team: str, include_review: bool = False) -> str:
    prompt = f"""
–¢—ã ‚Äî –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –∏ –Ω–µ–º–Ω–æ–≥–æ –ø–æ—ç—Ç–∏—á–Ω—ã–π Telegram-–±–æ—Ç –∫–ª–∏–Ω–∏–Ω–≥–æ–≤–æ–π –∫–æ–º–ø–∞–Ω–∏–∏.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é —É–±–æ—Ä–∫–∏ –ø–æ–¥—ä–µ–∑–¥–æ–≤ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–æ–µ, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (5-7 —Å—Ç—Ä–æ–∫).
–§–æ—Ä–º–∞—Ç:
1. –ó–∞–≥–æ–ª–æ–≤–æ–∫: "–£–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
2. –ê–¥—Ä–µ—Å (—É–∂–µ –≤—Å—Ç–∞–≤–ª–µ–Ω)
3. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (—É–∂–µ –≤—Å—Ç–∞–≤–ª–µ–Ω)
4. –ù–æ–º–µ—Ä –±—Ä–∏–≥–∞–¥—ã (—É–∂–µ –≤—Å—Ç–∞–≤–ª–µ–Ω)
5. –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: —Å —é–º–æ—Ä–æ–º, –≤ —Å—Ç–∏—Ö–∞—Ö, —Ñ—Ä–∞–∑–∞—Ö, —Ü–∏—Ç–∞—Ç–∞—Ö, –ø–æ–ª–µ–∑–Ω—ã—Ö —Ñ–∞–∫—Ç–∞—Ö –∏–ª–∏ –ø—Ä–æ–¥–∞—é—â–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º.
–ù–µ –ø–∏—à–∏ –∞–¥—Ä–µ—Å, –¥–∞—Ç—É, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ, –Ω–æ–º–µ—Ä –±—Ä–∏–≥–∞–¥—ã ‚Äî –æ–Ω–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –æ—Ç–¥–µ–ª—å–Ω–æ.
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown, —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç.
–í—Å–µ–≥–¥–∞ —Ä–∞–∑–Ω—ã–π —Ç–µ–∫—Å—Ç.
"""

    if include_review:
        prompt += """

–¢–∞–∫–∂–µ –¥–æ–±–∞–≤—å 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –±–∞–π—Ç–æ–º –Ω–∞ –æ—Ç–∑—ã–≤, –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º, –Ω–µ –æ–¥–Ω–æ—Ç–∏–ø–Ω—ã–º.
–í–æ—Ç —Å—Å—ã–ª–∫–∏ –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤ (—É–∫–∞–∂–∏ –∫–∞–∫ [—Å—Å—ã–ª–∫–∞1], [—Å—Å—ã–ª–∫–∞2]):
""" + "\n".join(REVIEW_LINKS)

    try:
        response = await client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[{"role": "user", "content": prompt}],
            temperature=1.0,
        )
        message = response.choices[0].message.content.strip()
        logger.info(f"üß† GPT —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª: ---\n{message}")
        return message
    except Exception as e:
        logger.error(f"‚ùå GPT –æ—à–∏–±–∫–∞: {e}")
        return "–°–ø–∞—Å–∏–±–æ –∑–∞ —á–∏—Å—Ç–æ—Ç—É! –ö–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤–∞—à–µ–≥–æ –∫–æ–º—Ñ–æ—Ä—Ç–∞. –û—Ü–µ–Ω–∏—Ç–µ –Ω–∞—Å –ø–æ —Å—Å—ã–ª–∫–µ: [—Å—Å—ã–ª–∫–∞1] [—Å—Å—ã–ª–∫–∞2]"